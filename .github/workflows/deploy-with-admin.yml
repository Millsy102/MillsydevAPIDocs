name: Deploy with Secure Admin

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        
    - name: Create Admin Config
      run: |
        # Create secure admin configuration from environment variables
        cat > docs/_config_admin.yml << EOF
        # Admin Panel Configuration
        # Generated from environment variables
        
        admin:
          enabled: ${{ env.ADMIN_ENABLED || 'true' }}
          username: "${{ secrets.ADMIN_USERNAME || 'admin' }}"
          password_hash: "${{ secrets.ADMIN_PASSWORD_HASH }}"
          session_timeout: 86400
          max_attempts: 3
          lockout_duration: 900
        
        security:
          rate_limiting: true
          access_logging: true
          session_encryption: true
        
        analytics:
          tracking_enabled: true
          data_retention_days: 30
          export_enabled: true
        EOF
        
    - name: Build Jekyll Site
      run: |
        cd docs
        bundle exec jekyll build
        
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/_site
        
    - name: Cleanup
      run: |
        # Remove sensitive config file
        rm -f docs/_config_admin.yml
