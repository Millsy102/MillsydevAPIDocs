<!-- Analytics Tracker for Admin Panel -->
<script>
class AnalyticsTracker {
    constructor() {
        this.storageKey = 'site_analytics';
        this.sessionKey = 'analytics_session';
        this.init();
    }
    
    init() {
        this.trackPageView();
        this.trackSession();
        this.trackUserInteraction();
    }
    
    trackPageView() {
        const pageData = {
            url: window.location.pathname,
            title: document.title,
            timestamp: Date.now(),
            referrer: document.referrer,
            userAgent: navigator.userAgent
        };
        
        this.storeEvent('page_view', pageData);
    }
    
    trackSession() {
        let session = JSON.parse(localStorage.getItem(this.sessionKey) || '{}');
        
        if (!session.id || Date.now() - session.lastActivity > 30 * 60 * 1000) { // 30 minutes
            session = {
                id: this.generateSessionId(),
                startTime: Date.now(),
                lastActivity: Date.now(),
                pageViews: 0
            };
        }
        
        session.lastActivity = Date.now();
        session.pageViews++;
        localStorage.setItem(this.sessionKey, JSON.stringify(session));
        
        this.storeEvent('session_update', session);
    }
    
    trackUserInteraction() {
        // Track clicks on important elements
        document.addEventListener('click', (e) => {
            const target = e.target;
            const interaction = {
                type: 'click',
                element: target.tagName,
                id: target.id,
                className: target.className,
                text: target.textContent?.substring(0, 50),
                url: target.href,
                timestamp: Date.now()
            };
            
            this.storeEvent('interaction', interaction);
        });
        
        // Track form submissions
        document.addEventListener('submit', (e) => {
            const form = e.target;
            const formData = {
                action: form.action,
                method: form.method,
                fields: Array.from(form.elements).map(el => ({
                    name: el.name,
                    type: el.type
                })),
                timestamp: Date.now()
            };
            
            this.storeEvent('form_submit', formData);
        });
        
        // Track downloads
        document.addEventListener('click', (e) => {
            const target = e.target;
            if (target.href && this.isDownloadLink(target.href)) {
                this.storeEvent('download', {
                    url: target.href,
                    filename: target.download || target.href.split('/').pop(),
                    timestamp: Date.now()
                });
            }
        });
    }
    
    isDownloadLink(url) {
        const downloadExtensions = ['.pdf', '.zip', '.json', '.csv', '.xlsx', '.doc', '.docx'];
        return downloadExtensions.some(ext => url.toLowerCase().includes(ext));
    }
    
    storeEvent(type, data) {
        const events = JSON.parse(localStorage.getItem(this.storageKey) || '[]');
        events.push({
            type,
            data,
            timestamp: Date.now()
        });
        
        // Keep only last 1000 events to prevent storage bloat
        if (events.length > 1000) {
            events.splice(0, events.length - 1000);
        }
        
        localStorage.setItem(this.storageKey, JSON.stringify(events));
    }
    
    generateSessionId() {
        return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    getAnalytics() {
        const events = JSON.parse(localStorage.getItem(this.storageKey) || '[]');
        const sessions = JSON.parse(localStorage.getItem(this.sessionKey) || '{}');
        
        // Calculate metrics
        const pageViews = events.filter(e => e.type === 'page_view').length;
        const uniqueSessions = new Set(events.filter(e => e.type === 'session_update').map(e => e.data.id)).size;
        
        // Get popular pages
        const pageViewEvents = events.filter(e => e.type === 'page_view');
        const pageCounts = {};
        pageViewEvents.forEach(event => {
            const url = event.data.url;
            pageCounts[url] = (pageCounts[url] || 0) + 1;
        });
        
        const popularPages = Object.entries(pageCounts)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 10)
            .map(([page, views]) => ({ page, views }));
        
        // Get recent activity
        const recentActivity = events
            .slice(-20)
            .reverse()
            .map(event => {
                const timeAgo = this.getTimeAgo(event.timestamp);
                switch (event.type) {
                    case 'page_view':
                        return {
                            action: 'Page View',
                            page: event.data.url,
                            time: timeAgo
                        };
                    case 'download':
                        return {
                            action: 'Download',
                            file: event.data.filename,
                            time: timeAgo
                        };
                    case 'form_submit':
                        return {
                            action: 'Form Submit',
                            page: event.data.action,
                            time: timeAgo
                        };
                    default:
                        return {
                            action: event.type,
                            page: event.data.url || 'Unknown',
                            time: timeAgo
                        };
                }
            });
        
        return {
            pageViews,
            uniqueVisitors: uniqueSessions,
            popularPages,
            recentActivity,
            totalEvents: events.length,
            lastUpdated: Date.now()
        };
    }
    
    getTimeAgo(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)} minutes ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)} hours ago`;
        return `${Math.floor(diff / 86400000)} days ago`;
    }
    
    exportData() {
        const analytics = this.getAnalytics();
        const events = JSON.parse(localStorage.getItem(this.storageKey) || '[]');
        
        const exportData = {
            summary: analytics,
            rawEvents: events,
            exportDate: new Date().toISOString(),
            userAgent: navigator.userAgent
        };
        
        return exportData;
    }
    
    clearData() {
        localStorage.removeItem(this.storageKey);
        localStorage.removeItem(this.sessionKey);
    }
}

// Initialize analytics tracker
document.addEventListener('DOMContentLoaded', () => {
    window.analyticsTracker = new AnalyticsTracker();
});

// Enhanced admin auth with real analytics
if (window.adminAuth) {
    const originalLoadAnalytics = window.adminAuth.loadAnalytics;
    window.adminAuth.loadAnalytics = function() {
        if (window.analyticsTracker) {
            const realAnalytics = window.analyticsTracker.getAnalytics();
            
            document.getElementById('page-views').textContent = realAnalytics.pageViews.toLocaleString();
            document.getElementById('unique-visitors').textContent = realAnalytics.uniqueVisitors.toLocaleString();
            
            const popularPagesHtml = realAnalytics.popularPages.map(page => 
                `<div class="metric-item">${page.page} <span class="metric-count">${page.views}</span></div>`
            ).join('');
            document.getElementById('popular-pages').innerHTML = popularPagesHtml;
            
            const activityHtml = realAnalytics.recentActivity.map(activity => 
                `<div class="activity-item">${activity.action}: ${activity.page || activity.file} <span class="activity-time">${activity.time}</span></div>`
            ).join('');
            document.getElementById('recent-activity').innerHTML = activityHtml;
        } else {
            // Fallback to original method
            originalLoadAnalytics.call(this);
        }
    };
}
</script>
